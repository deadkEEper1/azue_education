<mxfile host="app.diagrams.net" modified="2023-02-17T16:17:35.450Z" agent="5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36" etag="4XwNvTy8U5xuebog0v-y" version="20.8.20" type="github">
  <diagram name="Page-1" id="t9uQAWmX41yd_XQ180Mt">
    <mxGraphModel dx="1884" dy="1038" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1200" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-1" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="5" y="440" width="200" height="345" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-2" value="" style="strokeWidth=2;html=1;shape=mxgraph.flowchart.database;whiteSpace=wrap;" vertex="1" parent="1">
          <mxGeometry x="40" y="660" width="120" height="120" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-3" value="" style="verticalLabelPosition=bottom;html=1;verticalAlign=top;align=center;strokeColor=none;fillColor=#00BEF2;shape=mxgraph.azure.service_endpoint;" vertex="1" parent="1">
          <mxGeometry x="210" y="610" width="50" height="20" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-4" value="&lt;font style=&quot;font-size: 19px;&quot;&gt;Eng portal&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="50" y="420" width="110" height="40" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-5" value="" style="aspect=fixed;html=1;points=[];align=center;image;fontSize=12;image=img/lib/azure2/management_governance/Resource_Graph_Explorer.svg;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="590" y="220" width="115.16" height="110" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-6" value="Resources" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=30;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;strokeWidth=3;fontSize=19;" vertex="1" parent="1">
          <mxGeometry x="567.58" y="20" width="160" height="120" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-7" value="id" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-6">
          <mxGeometry y="30" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-8" value="type" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-6">
          <mxGeometry y="60" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-9" value="....&lt;br&gt;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-6">
          <mxGeometry y="90" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-10" value="ResourceChanges" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=30;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;strokeWidth=3;fontSize=19;" vertex="1" parent="1">
          <mxGeometry x="820" y="10" width="200" height="120" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-11" value="id" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-10">
          <mxGeometry y="30" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-12" value="properties" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-10">
          <mxGeometry y="60" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-13" value="...." style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-10">
          <mxGeometry y="90" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-14" value="UpToDateResources" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=30;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;strokeWidth=3;fontSize=19;" vertex="1" parent="1">
          <mxGeometry x="1365" y="645" width="235" height="150" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-15" value="id" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-14">
          <mxGeometry y="30" width="235" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-16" value="resourceId" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-14">
          <mxGeometry y="60" width="235" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-18" value="resourceJSON" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-14">
          <mxGeometry y="90" width="235" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-17" value="isSentToEngPortal" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-14">
          <mxGeometry y="120" width="235" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-19" value="" style="edgeStyle=entityRelationEdgeStyle;fontSize=12;html=1;endArrow=ERmandOne;startArrow=ERmandOne;rounded=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="L1L9Y7wpmhGUglrIA7kA-7" target="L1L9Y7wpmhGUglrIA7kA-16">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="740" y="480" as="sourcePoint" />
            <mxPoint x="840" y="380" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-21" value="" style="aspect=fixed;html=1;points=[];align=center;image;fontSize=12;image=img/lib/azure2/compute/Function_Apps.svg;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="597.66" y="440" width="136" height="120" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-22" value="1) Migrration function" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=19;" vertex="1" parent="1">
          <mxGeometry x="594" y="410" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-23" value="" style="aspect=fixed;html=1;points=[];align=center;image;fontSize=12;image=img/lib/azure2/compute/Function_Apps.svg;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="604" y="600" width="136" height="120" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-24" value="2) Keep resources up to date function" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=19;" vertex="1" parent="1">
          <mxGeometry x="587.66" y="560" width="340" height="40" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-25" value="" style="aspect=fixed;html=1;points=[];align=center;image;fontSize=12;image=img/lib/azure2/compute/Function_Apps.svg;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="604" y="750" width="136" height="120" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-26" value="3) Send up to date resources to eng portal endpoint" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=19;" vertex="1" parent="1">
          <mxGeometry x="587.66" y="720" width="460" height="40" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-30" value="&lt;h1&gt;Migration function&lt;/h1&gt;&lt;div&gt;That is once to run function. After it is completed execution. We may say we have UpToDateData at that very moment. Next step is to implement the mechanism to keep that data up to date&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1) Get data from Resources table&lt;/div&gt;&lt;div&gt;2) Store it in temporary db&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The source table is read only and has 22k records. Would be nice to have that data in our writable table, so we are able to track status. UpToDateResources is temporary table that has 1 to 1 relation with Resources table and contains next fields. id, resourceid(foreign key for resources table), resourceJSON(there is no need to track every field, we will store it as it is in signle column to avoid potentially time consuming column managment issues)&lt;/div&gt;&lt;div&gt;isSentToEngPortal - flag field to know the resource is synched.&amp;nbsp;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;fontSize=19;" vertex="1" parent="1">
          <mxGeometry y="920" width="375" height="490" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-31" value="&lt;h1&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;Keep resources up to date function&lt;/span&gt;&lt;/h1&gt;&lt;div&gt;That function is responsible for keepeng Resources up to date. To achive it we may use ResourceChanges collection. This function is to be run once per Unit(day, hour ....). ResourceChanges is read only table,&amp;nbsp; to track status we will store Changes in temporary db so we are able to track the changes were appliyed to our upToDateResources&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1) Grab all Resource changes for given period&lt;/div&gt;&lt;div&gt;2) Store them in temp table resourceChanges.&lt;/div&gt;&lt;div&gt;3) Apply all the changes to UpToDateResource so we are sure it becomes up to date&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There are 3 possible eventTypes [Create, update, delete]. To apply changes.&lt;/div&gt;&lt;div&gt;To handle Delete event:&lt;/div&gt;&lt;div&gt;1) Delete resource from UpToDateResources by resourceId&lt;/div&gt;&lt;div&gt;2) Create/Update - get Resource from GraphApi by resourceId and overwtrite UpToDateResource with the upToDateData.&amp;nbsp;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;fontSize=19;" vertex="1" parent="1">
          <mxGeometry x="419" y="920" width="375" height="770" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-34" value="TmpResourceChanges" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=30;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;strokeWidth=3;fontSize=19;" vertex="1" parent="1">
          <mxGeometry x="1365" y="470" width="235" height="150" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-35" value="id" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-34">
          <mxGeometry y="30" width="235" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-36" value="resourceChangeId" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-34">
          <mxGeometry y="60" width="235" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-37" value="resourceChangeJSON" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-34">
          <mxGeometry y="90" width="235" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-40" value="isApplied" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;fontSize=19;" vertex="1" parent="L1L9Y7wpmhGUglrIA7kA-34">
          <mxGeometry y="120" width="235" height="30" as="geometry" />
        </mxCell>
        <mxCell id="L1L9Y7wpmhGUglrIA7kA-38" value="" style="edgeStyle=entityRelationEdgeStyle;fontSize=12;html=1;endArrow=ERmandOne;startArrow=ERmandOne;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="L1L9Y7wpmhGUglrIA7kA-11" target="L1L9Y7wpmhGUglrIA7kA-36">
          <mxGeometry width="100" height="100" relative="1" as="geometry">
            <mxPoint x="1020" y="60" as="sourcePoint" />
            <mxPoint x="1657" y="715" as="targetPoint" />
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
